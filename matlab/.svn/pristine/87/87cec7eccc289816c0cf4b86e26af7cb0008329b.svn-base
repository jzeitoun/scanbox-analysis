function [m,mu,disp] = sbxalign_nonrigid(fname,idx)

if(length(idx)==1)
    A = squeeze(sbxread(fname,idx(1),1));
    m = A;
    mu = A;
    disp = {zeros([size(A) 2])};
elseif (length(idx)==2)
    A = squeeze(sbxread(fname,idx(1),1));
    B = squeeze(sbxread(fname,idx(2),1));
    [D,Ar] = imregdemons(A,B,[32 16 8 4],'AccumulatedFieldSmoothing',2.5,'PyramidLevels',4,'DisplayWaitBar',false);
    m = (Ar/2+B/2);
    mu = (A/2+B/2);
    disp = {D zeros([size(A) 2])};
else
    idx0 = idx(1:floor(end/2));
    idx1 = idx(floor(end/2)+1 : end);
    [A,acc0,D0] = sbxalign_nonrigid(fname,idx0);
    [B,acc1,D1] = sbxalign_nonrigid(fname,idx1);
   
    [D,Ar] = imregdemons(A,B,[32 16 8 4],'AccumulatedFieldSmoothing',2.5,'PyramidLevels',4,'DisplayWaitBar',false);
    m = (Ar/2+B/2);
    mu = (A/2+B/2);
    
    for(i=1:length(D0))
        D0{i} = D0{i}+D;
    end
    disp = {D0{:} D1{:}};
end
